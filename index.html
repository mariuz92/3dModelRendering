<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- CSS only -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />
    <title>xeokit Example</title>
    <style>
      body {
        margin: 0;
        width: 100%;
        height: 100%;
        user-select: none;
        overflow: hidden;
      }

      #myCanvas {
        width: 100%;
        height: 100%;
        position: absolute;
        background: lightblue;
        background-image: linear-gradient(lightblue, white);
      }

      .xeokit-camera-pivot-marker {
        color: #ffffff;
        position: absolute;
        width: 25px;
        height: 25px;
        border-radius: 15px;
        border: 2px solid #ebebeb;
        background: black;
        visibility: hidden;
        box-shadow: 5px 5px 15px 1px #3e3e3e;
        z-index: 10000;
        pointer-events: none;
      }

      .annotation-marker {
        color: #ffffff;
        text-align: center;
        font-weight: bold;
        position: absolute;
        border-radius: 15px;
        box-shadow: 5px 5px 15px 1px #3e3e3e;
        z-index: 0;
      }

      .annotation-label {
        position: absolute;
        box-shadow: 5px 5px 15px 1px #3e3e3e;
        z-index: 90000;
      }

      .card {
        width: 350px;
      }

      .value {
        font-size: x-large;
        box-shadow: rgba(0, 0, 0, 0.85) 0px 5px 15px;
        border: 5px solid #3e3e3e;
        display: flex;
        justify-content: center;
        height: 70px;
        width: 70px;
        align-items: center;
        margin: auto;
      }

      /* .annotation-label:after {
        content: "";
        position: absolute;
        border-style: solid;
        border-width: 8px 12px 8px 0;
        border-color: transparent white;
        display: block;
        width: 0;
        z-index: 1;
        margin-top: -11px;
        left: -12px;
        top: 20px;
      }

      .annotation-label:before {
        content: "";
        position: absolute;
        border-style: solid;
        border-width: 9px 13px 9px 0;
        border-color: transparent #ffffff;
        display: block;
        width: 0;
        z-index: 0;
        margin-top: -12px;
        left: -15px;
        top: 20px;
      } */

      .annotation-title {
        font: normal 20px arial, serif;
        margin-bottom: 8px;
      }

      .annotation-desc {
        font: normal 14px arial, serif;
      }
    </style>
  </head>

  <body>
    <canvas id="myCanvas"></canvas>
  </body>
  <script id="source" type="module">
    import {
      Viewer,
      AnnotationsPlugin,
      STLLoaderPlugin,
      DistanceMeasurementsPlugin,
      XKTLoaderPlugin,
      Mesh,
      LineSet,
      buildGridGeometry,
      PhongMaterial,
    } from 'https://cdn.jsdelivr.net/npm/@xeokit/xeokit-sdk/dist/xeokit-sdk.es.min.js'

    const viewer = new Viewer({
      canvasId: 'myCanvas',
      transparent: true,
    })

    const scene = viewer.scene
    const cameraFlight = viewer.cameraFlight
    const camera = scene.camera

    viewer.camera.eye = [0, 30, 80]

    const xktLoader = new XKTLoaderPlugin(viewer)

    const model = xktLoader.load({
      id: 'myModel',
      src: './files/OTCConferenceCenter.ifc.xkt',
      edges: true,
      position: [-49.5, 0, 30],
      saoEnabled: false,
    })
    const geometryArrays = buildGridGeometry({
      size: 105,
      divisions: 5,
    })

    new LineSet(viewer.scene, {
      positions: geometryArrays.positions,
      indices: geometryArrays.indices,
      color: [0, 0, 0],
    })

    //------------------------------------------------------------------------------------------------------------------
    // Customize CameraControl
    //------------------------------------------------------------------------------------------------------------------

    const cameraControl = viewer.cameraControl

    cameraControl.navMode = 'orbit'
    cameraControl.followPointer = true

    const pivotElement = document
      .createRange()
      .createContextualFragment(
        "<div class='xeokit-camera-pivot-marker'></div>",
      ).firstChild
    document.body.appendChild(pivotElement)

    cameraControl.pivotElement = pivotElement

    //------------------------------------------------------------------------------------------------------------------
    // Create an AnnotationsPlugin, with which we'll create annotations
    //------------------------------------------------------------------------------------------------------------------

    const annotations = new AnnotationsPlugin(viewer, {
      markerHTML:
        "<button class='btn annotation-marker rounded' style='background-color: {{markerBGColor}};'>{{glyph}}</button>",
      labelHTML:
        '<div class="card mb-3 annotation-label" style="max-width: 540px;">\
  <div class="row g-0">\
    <div class="col-md-4 d-flex">\
      <div class="value rounded-circle"> 3,0 </div>\
    </div>\
    <div class="col-md-8">\
      <div class="card-body">\
        <h5 class="card-title">{{title}}</h5>\
        <p class="card-text">{{description}}</p>\
        <p class="card-text"><small class="text-muted">Last updated 3 mins ago</small></p>\
      </div>\
    </div>\
  </div>\
</div>',
      values: {
        markerBGColor: 'red',
        labelBGColor: 'white',
        glyph: 'X',
        title: 'Untitled',
        description: 'No description',      
      },
    })

   var prevAnnotationClicked = null;

    annotations.on('markerClicked', (annotation) => {
      annotation.setLabelShown(!annotation.getLabelShown())
      viewer.cameraFlight.flyTo(annotation)
    })

 
    // annotations.on("markerClicked", (annotation) => {
    //   if (prevAnnotationClicked) {
    //     prevAnnotationClicked.setLabelShown(false);
    //     prevAnnotationClicked = null
    //   } else{
    //   annotation.setLabelShown(true);
    //   viewer.cameraFlight.flyTo(annotation);
    //   prevAnnotationClicked = annotation;
    //   }

    // });

    model.on('loaded', () => {
      //------------------------------------------------------------------------------------------------------------------
      // Create some Annotations
      //------------------------------------------------------------------------------------------------------------------

      const annotationList = [
        {
          id: 'an1',
          worldPos: [30, 4.5, 0],
          eye: [30, 6, 3],

          occludable: false,
          markerShown: true,
          labelShown: false,
          values: {
            glyph: 'Sensore numero 1',
            title: 'Front wall',
            description: 'This is the front wall',
            markerBGColor: 'green',
          },
        },
        {
          id: 'an2',
          worldPos: [30, 9, 0],
          eye: [30, 12, 3],

          occludable: false,
          markerShown: true,
          labelShown: false,
          values: {
            glyph: 'S2',
            title: 'Front wall',
            description: 'This is the front wall',
            markerBGColor: 'red',
          },
        },
        {
          id: 'an3',
          worldPos: [30, 13.5, 0],
          eye: [30, 16, 3],
          occludable: false,
          markerShown: true,
          labelShown: false,
          values: {
            glyph: 'S3',
            title: 'Front wall',
            description: 'This is the front wall',
            markerBGColor: 'orange',
          },
        },
        {
          id: 'an4',
          worldPos: [30, 18, 0],
          eye: [30, 21, 3],

          occludable: false,
          markerShown: true,
          labelShown: false,
          values: {
            glyph: 'S4',
            title: 'Front wall',
            description: 'This is the front wall',
            markerBGColor: 'green',
          },
        },
        {
          id: 'an5',
          worldPos: [30, 22.5, 0],
          eye: [30, 26, 3],
          // look: [33, 30, 4],
          //   up: [0, 1, 0],

          occludable: false,
          markerShown: true,
          labelShown: false,
          values: {
            glyph: 'S5',
            title: 'Front wall',
            description: 'This is the front wall',
            markerBGColor: 'black',
          },
        },
        {
          id: 'an6',
          worldPos: [30, 27, 0],
          eye: [30, 30, 3],

          occludable: false,
          markerShown: true,
          labelShown: false,
          values: {
            glyph: 'S6',
            title: 'Front wall',
            description: 'This is the front wall',
            markerBGColor: 'brown',
          },
        },
      ]

      annotationList.map((item) => {
        annotations.createAnnotation({
          id: item.id,
          worldPos: item.worldPos,
          eye: item.eye,
          look: item.look,
          up: item.up,
          occludable: item.occludable,
          markerShown: item.markerShown,
          labelShown: item.labelShown,
          values: {
            glyph: item.values.glyph,
            title: item.values.title,
            description: item.values.description,
            markerBGColor: item.values.markerBGColor,
          },
        })
      })

      //   annotations.createAnnotation({
      //     id: "myAnnotation1",

      //     worldPos: [0, 0, 0],

      //     eye: [0, 3.922, 16.919],
      //     look: [0, 3.293, 9.799],
      //     up: [0.0358, 0.987, -0.078],

      //     occludable: false,
      //     markerShown: true,
      //     labelShown: false,

      //     values: {
      //       glyph: "S1",
      //       title: "Front wall",
      //       description: "This is the front wall",
      //       markerBGColor: "green",
      //     },
      //   });
    })

    //------------------------------------------------------------------------------------------------------------------
    // Create an DistanceMeasurementsPlugin, activate its DistanceMeasuremntsControl
    //------------------------------------------------------------------------------------------------------------------

    // const distanceMeasurements = new DistanceMeasurementsPlugin(viewer);

    // distanceMeasurements.control.activate();
  </script>
</html>
